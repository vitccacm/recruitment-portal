{% extends "admin/base.html" %}
{% block title %}Accounts{% endblock %}

{% block content %}
<div class="flex justify-between items-center mb-xl">
    <div>
        <h1 class="page-title">Manage <span class="gradient-text">Accounts</span></h1>
        <p class="page-subtitle">Add and manage admin and department admin accounts</p>
    </div>
    <a href="{{ url_for('admin.add_account') }}" class="btn btn-primary">+ Add Account</a>
</div>

<div class="table-wrapper">
    <table>
        <thead>
            <tr>
                <th>Name</th>
                <th>Email/Username</th>
                <th>Role</th>
                <th>Department</th>
                <th>Created</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for admin in admins %}
            <tr>
                <td><strong>{{ admin.name or '-' }}</strong></td>
                <td>{{ admin.email }}</td>
                <td>
                    {% if admin.role == 'admin' %}
                    <span class="badge badge-open">Super Admin</span>
                    {% else %}
                    <span class="badge badge-pending">Dept Admin</span>
                    {% endif %}
                </td>
                <td>{{ admin.department.name if admin.department else '-' }}</td>
                <td>{{ admin.created_at.strftime('%b %d, %Y') }}</td>
                <td>
                    <div class="flex gap-sm">
                        {% if not (admin.email == 'admin' and admin.id == 1) %}
                        <a href="{{ url_for('admin.edit_account', admin_id=admin.id) }}"
                            class="btn btn-secondary btn-sm">Edit</a>
                        <button type="button" class="btn btn-sm" style="background: var(--warning); color: #000;"
                            onclick="openResetPasswordModal({{ admin.id }}, '{{ admin.email }}')">
                            Reset Password
                        </button>
                        <form method="POST" action="{{ url_for('admin.delete_account', admin_id=admin.id) }}"
                            onsubmit="return confirm('Are you sure you want to delete this account?');">
                            <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                        </form>
                        {% else %}
                        <span class="text-muted">Default Admin</span>
                        {% endif %}
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Reset Password Modal -->
<div id="resetPasswordModal" class="modal" style="display: none;">
    <div class="modal-content glass-card" style="max-width: 400px;">
        <h3 style="margin-bottom: 1.5rem;">Reset Password</h3>
        <p class="text-muted" style="margin-bottom: 1rem;">
            Resetting password for: <strong id="resetEmail"></strong>
        </p>
        <form id="resetPasswordForm" method="POST">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div class="form-group">
                <label class="form-label">New Password</label>
                <input type="password" name="new_password" id="newPassword" class="form-control" required minlength="6"
                    placeholder="Enter new password">
            </div>
            <div class="form-group">
                <label class="form-label">Confirm Password</label>
                <input type="password" name="confirm_password" id="confirmPassword" class="form-control" required
                    minlength="6" placeholder="Confirm new password">
            </div>
            <div class="flex gap-md mt-lg">
                <button type="submit" class="btn btn-primary" style="flex: 1;">Reset Password</button>
                <button type="button" class="btn btn-secondary" onclick="closeResetPasswordModal()">Cancel</button>
            </div>
        </form>
    </div>
</div>

<style>
    .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    .modal-content {
        padding: 2rem;
        animation: modalSlideIn 0.3s ease;
    }

    @keyframes modalSlideIn {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>

<script>
    function openResetPasswordModal(adminId, email) {
        document.getElementById('resetPasswordModal').style.display = 'flex';
        document.getElementById('resetEmail').textContent = email;
        document.getElementById('resetPasswordForm').action = '/admin/accounts/' + adminId + '/reset-password';
        document.getElementById('newPassword').value = '';
        document.getElementById('confirmPassword').value = '';
    }

    function closeResetPasswordModal() {
        document.getElementById('resetPasswordModal').style.display = 'none';
    }

    document.getElementById('resetPasswordForm').addEventListener('submit', function (e) {
        var newPass = document.getElementById('newPassword').value;
        var confirmPass = document.getElementById('confirmPassword').value;

        if (newPass !== confirmPass) {
            e.preventDefault();
            alert('Passwords do not match!');
            return false;
        }
    });

    // Close modal when clicking outside
    document.getElementById('resetPasswordModal').addEventListener('click', function (e) {
        if (e.target === this) {
            closeResetPasswordModal();
        }
    });
</script>
{% endblock %}