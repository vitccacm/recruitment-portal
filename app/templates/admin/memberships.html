{% extends "admin/base.html" %}
{% block title %}Memberships{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Membership Signups</h1>
    <p class="text-muted">Manage ACM membership applications</p>
</div>

<!-- Filter Tabs -->
<div class="tabs" style="margin-bottom: 1.5rem;">
    <a href="{{ url_for('admin.memberships', status='pending') }}"
        class="tab {% if current_status == 'pending' %}active{% endif %}">
        Pending ({{ counts.pending }})
    </a>
    <a href="{{ url_for('admin.memberships', status='archived') }}"
        class="tab {% if current_status == 'archived' %}active{% endif %}">
        Approved ({{ counts.archived }})
    </a>
    <a href="{{ url_for('admin.memberships', status='all') }}"
        class="tab {% if current_status == 'all' %}active{% endif %}">
        All ({{ counts.all }})
    </a>
</div>

{% if memberships %}
<form id="bulkForm" method="POST">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <!-- Bulk Actions -->
    <div class="bulk-actions glass-card"
        style="margin-bottom: 1rem; padding: 1rem; display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
            <input type="checkbox" id="selectAll" onclick="toggleSelectAll()">
            <span>Select All</span>
        </label>

        <span id="selectedCount" style="color: var(--text-muted);">0 selected</span>

        <div style="margin-left: auto; display: flex; gap: 0.5rem;">
            {% if current_status != 'archived' %}
            <button type="button" onclick="downloadAndApprove()" class="btn btn-success btn-sm" id="downloadBtn"
                disabled style="display: flex; align-items: center; gap: 0.25rem;">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
                Download & Approve
            </button>
            <button type="submit" formaction="{{ url_for('admin.archive_memberships') }}" class="btn btn-primary btn-sm"
                id="archiveBtn" disabled>
                Approve Selected
            </button>
            {% endif %}
            {% if current_status == 'archived' %}
            <button type="submit" formaction="{{ url_for('admin.unarchive_memberships') }}"
                class="btn btn-secondary btn-sm" id="unarchiveBtn" disabled>
                Move to Pending
            </button>
            {% endif %}
        </div>
    </div>

    <!-- Memberships Table -->
    <div class="glass-card" style="padding: 0; overflow-x: auto;">
        <table class="admin-table">
            <thead>
                <tr>
                    <th style="width: 40px;"></th>
                    <th>First Name</th>
                    <th>Last Name</th>
                    <th>Email</th>
                    <th>Signed Up</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for m in memberships %}
                <tr class="{% if m.is_archived %}archived-row{% endif %}" data-id="{{ m.id }}"
                    data-firstname="{{ m.first_name }}" data-lastname="{{ m.last_name }}" data-email="{{ m.email }}"
                    data-archived="{{ m.is_archived|lower }}">
                    <td>
                        <input type="checkbox" name="membership_ids" value="{{ m.id }}" class="row-checkbox"
                            onchange="updateSelectedCount()">
                    </td>
                    <td>{{ m.first_name }}</td>
                    <td>{{ m.last_name }}</td>
                    <td>
                        <a href="mailto:{{ m.email }}" style="color: var(--acm-blue);">{{ m.email }}</a>
                    </td>
                    <td>{{ m.created_at.strftime('%b %d, %Y') }}</td>
                    <td>
                        {% if m.is_archived %}
                        <span class="badge badge-open">Approved</span>
                        {% else %}
                        <span class="badge badge-upcoming">Pending</span>
                        {% endif %}
                    </td>
                    <td style="display: flex; gap: 0.5rem;">
                        {% if not m.is_archived %}
                        <form action="{{ url_for('admin.archive_single_membership', membership_id=m.id) }}"
                            method="POST" style="display: inline;">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit" class="btn btn-sm"
                                style="color: var(--success); background: transparent; padding: 0.25rem 0.5rem;">
                                Approve
                            </button>
                        </form>
                        {% else %}
                        <form action="{{ url_for('admin.unarchive_single_membership', membership_id=m.id) }}"
                            method="POST" style="display: inline;">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit" class="btn btn-sm"
                                style="color: var(--warning); background: transparent; padding: 0.25rem 0.5rem;">
                                Approved
                            </button>
                        </form>
                        {% endif %}
                        <form action="{{ url_for('admin.delete_membership', membership_id=m.id) }}" method="POST"
                            style="display: inline;"
                            onsubmit="return confirm('Are you sure you want to delete this membership?');">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit" class="btn btn-sm"
                                style="color: var(--error); background: transparent; padding: 0.25rem 0.5rem;">
                                Delete
                            </button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</form>
{% else %}
<div class="glass-card text-center" style="padding: 3rem;">
    <p class="text-muted">No membership signups found.</p>
</div>
{% endif %}

<style>
    .tabs {
        display: flex;
        gap: 0.5rem;
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 0;
    }

    .tab {
        padding: 0.75rem 1.25rem;
        color: var(--text-muted);
        text-decoration: none;
        border-bottom: 2px solid transparent;
        margin-bottom: -1px;
        transition: all 0.2s ease;
    }

    .tab:hover {
        color: var(--text-primary);
    }

    .tab.active {
        color: var(--acm-blue);
        border-bottom-color: var(--acm-blue);
    }

    .archived-row {
        opacity: 0.6;
    }

    .admin-table {
        width: 100%;
        border-collapse: collapse;
    }

    .admin-table th {
        text-align: left;
        padding: 1rem;
        background: rgba(0, 0, 0, 0.2);
        font-weight: 600;
        border-bottom: 1px solid var(--border-color);
    }

    .admin-table td {
        padding: 1rem;
        border-bottom: 1px solid var(--border-color);
    }

    .admin-table tr:last-child td {
        border-bottom: none;
    }

    .admin-table tr:hover td {
        background: rgba(255, 255, 255, 0.02);
    }

    .btn-sm {
        padding: 0.4rem 0.75rem;
        font-size: 0.875rem;
    }
</style>

<script>
    function toggleSelectAll() {
        const selectAll = document.getElementById('selectAll');
        const checkboxes = document.querySelectorAll('.row-checkbox');

        checkboxes.forEach(cb => {
            cb.checked = selectAll.checked;
        });

        updateSelectedCount();
    }

    function updateSelectedCount() {
        const checkboxes = document.querySelectorAll('.row-checkbox:checked');
        const count = checkboxes.length;
        document.getElementById('selectedCount').textContent = count + ' selected';

        const archiveBtn = document.getElementById('archiveBtn');
        const unarchiveBtn = document.getElementById('unarchiveBtn');
        const downloadBtn = document.getElementById('downloadBtn');

        if (archiveBtn) archiveBtn.disabled = count === 0;
        if (unarchiveBtn) unarchiveBtn.disabled = count === 0;
        if (downloadBtn) downloadBtn.disabled = count === 0;

        // Update select all checkbox state
        const allCheckboxes = document.querySelectorAll('.row-checkbox');
        const selectAll = document.getElementById('selectAll');
        if (allCheckboxes.length > 0) {
            selectAll.checked = count === allCheckboxes.length;
            selectAll.indeterminate = count > 0 && count < allCheckboxes.length;
        }
    }

    function downloadAndApprove() {
        const checkboxes = document.querySelectorAll('.row-checkbox:checked');
        if (checkboxes.length === 0) {
            alert('No memberships selected.');
            return;
        }

        // Collect membership data for CSV
        const csvRows = [];
        const membershipIds = [];

        checkboxes.forEach(cb => {
            const row = cb.closest('tr');
            const lastName = row.dataset.lastname;
            const firstName = row.dataset.firstname;
            const email = row.dataset.email;
            const isArchived = row.dataset.archived === 'true';

            // Add to CSV (lastname, firstname, email, affiliation)
            csvRows.push([
                lastName,
                firstName,
                email,
                'VIT Chennai Student'
            ].map(field => `"${(field || '').replace(/"/g, '""')}"`).join(','));

            // Only approve if not already archived
            if (!isArchived) {
                membershipIds.push(cb.value);
            }
        });

        // Generate and download CSV
        const csvContent = csvRows.join('\n');
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.setAttribute('href', url);
        link.setAttribute('download', 'acm_memberships.csv');
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);

        // Approve memberships via AJAX if there are any to approve
        if (membershipIds.length > 0) {
            const formData = new FormData();
            membershipIds.forEach(id => formData.append('membership_ids', id));
            formData.append('csrf_token', document.querySelector('input[name="csrf_token"]').value);

            fetch('{{ url_for("admin.archive_memberships") }}', {
                method: 'POST',
                body: formData
            }).then(response => {
                if (response.ok) {
                    // Reload the page to show updated status
                    window.location.reload();
                } else {
                    alert('Error approving memberships. Please try again.');
                }
            }).catch(error => {
                console.error('Error:', error);
                alert('Error approving memberships. Please try again.');
            });
        }
    }
</script>
{% endblock %}