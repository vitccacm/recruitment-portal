{% extends "admin/base.html" %}
{% block title %}Students{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Registered <span class="gradient-text">Students</span></h1>
    <p class="text-muted">All students who have signed up on the portal</p>
</div>

<!-- Stats -->
<div class="stats-grid mb-xl" style="grid-template-columns: repeat(3, 1fr);">
    <div class="stat-card">
        <div class="stat-value">{{ counts.total }}</div>
        <div class="stat-label">Total Students</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ counts.complete }}</div>
        <div class="stat-label">Profile Complete</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ counts.incomplete }}</div>
        <div class="stat-label">Profile Incomplete</div>
    </div>
</div>

<!-- Filter Tabs -->
<div style="display: flex; gap: 0; margin-bottom: 1.5rem; border-bottom: 2px solid var(--border-color);">
    <a href="{{ url_for('admin.students', status='all') }}"
        style="padding: 0.75rem 1.5rem; text-decoration: none; font-weight: 500; transition: all 0.2s;
               {% if current_status == 'all' %}color: var(--acm-blue); border-bottom: 2px solid var(--acm-blue); margin-bottom: -2px;
               {% else %}color: var(--text-muted); border-bottom: 2px solid transparent; margin-bottom: -2px;{% endif %}">
        All ({{ counts.total }})
    </a>
    <a href="{{ url_for('admin.students', status='complete') }}"
        style="padding: 0.75rem 1.5rem; text-decoration: none; font-weight: 500; transition: all 0.2s;
               {% if current_status == 'complete' %}color: var(--success); border-bottom: 2px solid var(--success); margin-bottom: -2px;
               {% else %}color: var(--text-muted); border-bottom: 2px solid transparent; margin-bottom: -2px;{% endif %}">
        ✓ Complete ({{ counts.complete }})
    </a>
    <a href="{{ url_for('admin.students', status='incomplete') }}"
        style="padding: 0.75rem 1.5rem; text-decoration: none; font-weight: 500; transition: all 0.2s;
               {% if current_status == 'incomplete' %}color: var(--warning); border-bottom: 2px solid var(--warning); margin-bottom: -2px;
               {% else %}color: var(--text-muted); border-bottom: 2px solid transparent; margin-bottom: -2px;{% endif %}">
        ⏳ Incomplete ({{ counts.incomplete }})
    </a>
</div>

{% if students %}
<!-- Students Table -->
<div class="glass-card" style="padding: 0; overflow-x: auto;">
    <table class="admin-table">
        <thead>
            <tr>
                <th>Name</th>
                <th>Email</th>
                <th>Reg No</th>
                <th>Branch</th>
                <th>Batch</th>
                <th>Profile</th>
                <th>Joined</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for s in students %}
            <tr>
                <td><strong>{{ s.name or 'Not set' }}</strong></td>
                <td>
                    <a href="mailto:{{ s.email }}" style="color: var(--acm-blue);">{{ s.email }}</a>
                </td>
                <td>{{ s.reg_no or '-' }}</td>
                <td>{{ s.branch or '-' }}</td>
                <td>{{ s.batch or '-' }}</td>
                <td>
                    {% if s.profile_completion >= 75 %}
                    <span class="badge badge-open">{{ s.profile_completion }}%</span>
                    {% else %}
                    <span class="badge badge-upcoming">{{ s.profile_completion }}%</span>
                    {% endif %}
                </td>
                <td>{{ s.created_at.strftime('%b %d, %Y') }}</td>
                <td>
                    <button type="button" class="btn btn-secondary btn-sm"
                        onclick="confirmDelete({{ s.id }}, '{{ s.name or s.email }}')"
                        style="background: var(--error); border-color: var(--error); padding: 0.25rem 0.5rem; font-size: 0.75rem;">
                        Delete
                    </button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal"
    style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 2000; align-items: center; justify-content: center;">
    <div class="glass-card" style="width: 90%; max-width: 450px; padding: 2rem;">
        <h3 style="margin-bottom: 1rem; color: var(--error);">Confirm Delete</h3>
        <p id="deleteMessage" style="margin-bottom: 1.5rem;"></p>
        <p class="text-muted" style="font-size: 0.85rem; margin-bottom: 1.5rem;">
            This will permanently delete:<br>
            • All applications by this student<br>
            • All question responses<br>
            • Round participation data<br>
            • Firebase authentication
        </p>
        <div style="display: flex; gap: 1rem;">
            <form id="deleteForm" method="POST" style="flex: 1;">
                <button type="submit" class="btn"
                    style="width: 100%; background: var(--error); border-color: var(--error);">
                    Yes, Delete
                </button>
            </form>
            <button type="button" class="btn btn-secondary" style="flex: 1;"
                onclick="closeDeleteModal()">Cancel</button>
        </div>
    </div>
</div>

<script>
    const deleteBaseUrl = "{{ url_for('admin.delete_student', student_id=0) }}".replace('/0', '');

    function confirmDelete(studentId, studentName) {
        document.getElementById('deleteMessage').textContent = `Are you sure you want to delete "${studentName}"?`;
        document.getElementById('deleteForm').action = deleteBaseUrl + '/' + studentId;
        document.getElementById('deleteModal').style.display = 'flex';
    }

    function closeDeleteModal() {
        document.getElementById('deleteModal').style.display = 'none';
    }
</script>
{% else %}
<div class="glass-card text-center">
    <p class="text-muted">No students found.</p>
</div>
{% endif %}
{% endblock %}