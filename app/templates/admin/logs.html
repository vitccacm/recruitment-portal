{% extends "admin/base.html" %}
{% block title %}Action Logs{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Action <span class="gradient-text">Logs</span></h1>
    <p class="text-muted">Track all actions performed on the system</p>
</div>

<!-- Filters -->
<div class="glass-card mb-lg" style="padding: 1rem;">
    <form method="GET" style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: flex-end;">
        <div class="form-group" style="margin-bottom: 0; flex: 1; min-width: 150px;">
            <label class="form-label" style="font-size: 0.8rem;">Area</label>
            <select name="area" class="form-control" style="padding: 0.5rem;">
                <option value="">All Areas</option>
                {% for area in areas %}
                <option value="{{ area }}" {% if current_area==area %}selected{% endif %}>{{ area }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group" style="margin-bottom: 0; flex: 1; min-width: 150px;">
            <label class="form-label" style="font-size: 0.8rem;">Action</label>
            <select name="action" class="form-control" style="padding: 0.5rem;">
                <option value="">All Actions</option>
                {% for action in actions %}
                <option value="{{ action }}" {% if current_action==action %}selected{% endif %}>{{ action }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group" style="margin-bottom: 0; flex: 1; min-width: 200px;">
            <label class="form-label" style="font-size: 0.8rem;">User Email</label>
            <input type="text" name="user" class="form-control" placeholder="Search by email..."
                value="{{ current_user_filter or '' }}" style="padding: 0.5rem;">
        </div>
        <button type="submit" class="btn btn-primary" style="padding: 0.5rem 1rem;">Filter</button>
        <a href="{{ url_for('admin.logs') }}" class="btn btn-secondary" style="padding: 0.5rem 1rem;">Reset</a>
    </form>
</div>

{% if logs %}
<!-- Logs Table -->
<div class="glass-card" style="padding: 0; overflow-x: auto;">
    <table class="admin-table">
        <thead>
            <tr>
                <th>Timestamp</th>
                <th>User</th>
                <th>Area</th>
                <th>Action</th>
                <th>Details</th>
                <th>IP</th>
            </tr>
        </thead>
        <tbody>
            {% for log in logs %}
            <tr>
                <td style="white-space: nowrap; font-size: 0.85rem;">
                    {{ log.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}
                </td>
                <td>
                    <span
                        class="badge {% if log.user_type == 'admin' %}badge-open{% elif log.user_type == 'student' %}badge-upcoming{% else %}badge-ended{% endif %}"
                        style="font-size: 0.7rem;">{{ log.user_type or 'system' }}</span>
                    <br><span style="font-size: 0.85rem;">{{ log.user_email or '-' }}</span>
                </td>
                <td>
                    <span class="badge" style="background: var(--bg-secondary); border: 1px solid var(--border-color);">
                        {{ log.area }}
                    </span>
                </td>
                <td style="font-weight: 500;">{{ log.action }}</td>
                <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; font-size: 0.85rem;">
                    {% if log.details %}
                    <code
                        style="font-size: 0.75rem; background: var(--bg-secondary); padding: 0.25rem 0.5rem; border-radius: 4px;">
                        {{ log.details[:100] }}{% if log.details|length > 100 %}...{% endif %}
                    </code>
                    {% else %}
                    -
                    {% endif %}
                </td>
                <td style="font-size: 0.8rem; color: var(--text-muted);">{{ log.ip_address or '-' }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Pagination -->
{% if pagination.pages > 1 %}
<div style="display: flex; justify-content: center; gap: 0.5rem; margin-top: 1.5rem;">
    {% if pagination.has_prev %}
    <a href="{{ url_for('admin.logs', page=pagination.prev_num, area=current_area, user=current_user_filter, action=current_action) }}"
        class="btn btn-secondary btn-sm">Previous</a>
    {% endif %}

    <span style="padding: 0.5rem 1rem; color: var(--text-muted);">
        Page {{ pagination.page }} of {{ pagination.pages }}
    </span>

    {% if pagination.has_next %}
    <a href="{{ url_for('admin.logs', page=pagination.next_num, area=current_area, user=current_user_filter, action=current_action) }}"
        class="btn btn-secondary btn-sm">Next</a>
    {% endif %}
</div>
{% endif %}

{% else %}
<div class="glass-card text-center">
    <p class="text-muted">No logs found.</p>
</div>
{% endif %}
{% endblock %}